<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puissance 4 - En jeu</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <!-- BOUTON RETOUR MENU -->
  <a href="/" class="menu-btn">
    <span class="menu-icon">⬅️</span>
    <span class="menu-text">Menu</span>
  </a>

  <!-- CONTRÔLE AUDIO -->
  <button id="audioToggle" class="audio-toggle" title="Activer/Désactiver le son" aria-label="Toggle audio">
    <span id="audioIcon" class="audio-icon">🔊</span>
  </button>

  <h1>🎮 Drop 4 🎮</h1>
  
  <!-- TABLEAU DE SCORES NÉON -->
  <div class="scoreboard neon">
    <div class="player-label red">{{.Player1Name}}</div>
    <div class="score-value">{{.ScoreP1}}</div>
    <div class="score-separator">-</div>
    <div class="score-value">{{.ScoreP2}}</div>
    <div class="player-label yellow">{{.Player2Name}}</div>
  </div>

  <!-- STATISTIQUES -->
  <div class="stats-container">
    <div class="stat-box">
      <div class="stat-label">Parties jouées</div>
      <div class="stat-value">{{.GamesPlayed}}</div>
    </div>
    {{if .AIMode}}
    <div class="stat-box ai-difficulty">
      <div class="stat-label">Difficulté IA</div>
      <div class="stat-value difficulty-{{.AIDifficulty}}">
        {{if eq .AIDifficulty "facile"}}😊 Facile{{end}}
        {{if eq .AIDifficulty "moyen"}}🤔 Moyen{{end}}
        {{if eq .AIDifficulty "difficile"}}😈 Difficile{{end}}
      </div>
    </div>
    {{end}}
  </div>

  <!-- INFO JOUEUR -->
  {{if .GameOver}}
    {{if eq .Winner 0}}
      <div class="player-info draw-message">
        <span class="info-icon">⚖️</span>
        <span class="info-text">Match nul !</span>
      </div>
    {{else}}
      <div class="player-info winner">
        <span class="trophy-icon">🏆</span>
        <span class="winner-text">{{.GetWinnerName}} a gagné !</span>
        <span class="trophy-icon">🏆</span>
      </div>
    {{end}}
  {{else}}
    <div class="player-info current-turn">
      <span class="turn-indicator"></span>
      <span class="turn-text">Au tour de <strong>{{.GetCurrentPlayerName}}</strong></span>
    </div>
  {{end}}
  
  <!-- Message d'erreur -->
  {{if .ErrorMessage}}
    <div class="error-message">
      <span class="error-icon">⚠️</span>
      {{.ErrorMessage}}
    </div>
  {{end}}
  
  <!-- OVERLAY IA -->
  <div id="aiThinking" class="ai-thinking-overlay" style="display: none;">
    <div class="ai-thinking-content">
      <div class="ai-brain-container">
        <div class="ai-brain">🤖</div>
        <div class="thinking-dots">
          <span class="dot">.</span>
          <span class="dot">.</span>
          <span class="dot">.</span>
        </div>
      </div>
      <div class="ai-thinking-text">
        <p class="ai-main-text">L'ordinateur réfléchit</p>
        <p class="ai-sub-text" id="aiSubText">Analyse du plateau...</p>
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- GRILLE DE JEU -->
  <div class="game-container">
    <div class="grid">
      {{range $i := Seq 6}}
        {{range $j := Seq 7}}
          <form method="POST" action="/play" style="margin: 0; padding: 0;" class="cell-form" data-column="{{$j}}">
            <input type="hidden" name="column" value="{{$j}}">
            <button type="submit" class="cell" {{if $.GameOver}}disabled{{end}} {{if IsColumnFull $j}}disabled{{end}}>
              {{$cellValue := $.GetCell $i $j}}
              {{if eq $cellValue 1}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token red {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{else if eq $cellValue 2}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token yellow {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{end}}
            </button>
          </form>
        {{end}}
      {{end}}
    </div>

    <!-- Historique des coups -->
    {{if .History}}
    <div class="history-panel">
      <h3>📜 Historique des coups</h3>
      <div class="history-stats">
        <span>Total: {{len .History}} coups</span>
      </div>
      <div class="history-list">
        {{range $index, $move := .History}}
          <div class="history-item {{if eq $index (sub (len $.History) 1)}}last-move{{end}}">
            <span class="move-number">#{{add $index 1}}</span>
            <span class="move-player">{{if eq $move.Player 1}}🔴{{else}}🟡{{end}}</span>
            <span class="move-column">Colonne {{add $move.Column 1}}</span>
          </div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  <!-- BOUTONS DE CONTRÔLE -->
  <div class="button-container">
    <form method="POST" action="/reset" style="margin: 0;">
      <button type="submit" class="reset-btn">
        <span class="btn-icon">🔄</span>
        <span class="btn-text">Nouvelle Partie</span>
      </button>
    </form>
    <form method="POST" action="/reset-scores" style="margin: 0;">
      <button type="submit" class="score-reset-btn">
        <span class="btn-icon">📊</span>
        <span class="btn-text">Reset Scores</span>
      </button>
    </form>
  </div>

  <!-- DONNÉES DU JEU -->
  <div id="gameData" style="display: none;"
     data-ai-mode="{{if .AIMode}}true{{else}}false{{end}}"
     data-current-player="{{.Player}}"
     data-game-over="{{.GameOver}}"
     data-winner="{{.Winner}}"
     data-sound-to-play="{{.SoundToPlay}}"
     data-ai-difficulty="{{.AIDifficulty}}"
     data-has-history="{{if .History}}{{len .History}}{{else}}0{{end}}">
  </div>

  <script>
    // ============================================
    // 🎵 SYSTÈME AUDIO SYNTHÉTIQUE WEB AUDIO API
    // ============================================
    
    let audioContext = null;
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    let bgOscillator = null;
    let bgGain = null;
    let musicStarted = false;
    
    // Initialiser AudioContext
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('🎵 AudioContext créé');
      }
      return audioContext;
    }
    
    // ===== SONS SYNTHÉTIQUES =====
    
    // Son DROP (jeton qui tombe)
    function playDropSound() {
      if (!audioEnabled) return;
      const ctx = initAudio();
      
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      // Effet de chute: fréquence qui descend
      osc.frequency.setValueAtTime(800, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.15);
      osc.type = 'sine';
      
      gain.gain.setValueAtTime(0.3, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.15);
      
      console.log('🔊 DROP');
    }
    
    // Son VICTOIRE (mélodie joyeuse Do-Mi-Sol-Do)
    function playWinSound() {
      if (!audioEnabled) return;
      const ctx = initAudio();
      
      const notes = [523.25, 659.25, 783.99, 1046.50];
      const duration = 0.2;
      
      notes.forEach((freq, i) => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.frequency.value = freq;
        osc.type = 'sine';
        
        const startTime = ctx.currentTime + (i * duration);
        gain.gain.setValueAtTime(0.25, startTime);
        gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
        
        osc.start(startTime);
        osc.stop(startTime + duration);
      });
      
      console.log('🎉 VICTOIRE');
    }
    
    // Son DÉFAITE (son descendant triste)
    function playLoseSound() {
      if (!audioEnabled) return;
      const ctx = initAudio();
      
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.frequency.setValueAtTime(400, ctx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(150, ctx.currentTime + 0.8);
      osc.type = 'triangle';
      
      gain.gain.setValueAtTime(0.2, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.8);
      
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.8);
      
      console.log('😢 DÉFAITE');
    }
    
    // Musique de fond (drone ambiant)
    function startBgMusic() {
      if (!audioEnabled || musicStarted) return;
      const ctx = initAudio();
      
      bgOscillator = ctx.createOscillator();
      bgGain = ctx.createGain();
      
      bgOscillator.connect(bgGain);
      bgGain.connect(ctx.destination);
      
      bgOscillator.frequency.value = 110; // La grave
      bgOscillator.type = 'sine';
      
      bgGain.gain.setValueAtTime(0, ctx.currentTime);
      bgGain.gain.linearRampToValueAtTime(0.05, ctx.currentTime + 2);
      
      bgOscillator.start();
      
      // Harmonique
      const osc2 = ctx.createOscillator();
      osc2.connect(bgGain);
      osc2.frequency.value = 165; // Mi
      osc2.type = 'sine';
      osc2.start();
      
      musicStarted = true;
      console.log('🎵 Musique démarrée');
    }
    
    function stopBgMusic() {
      if (bgOscillator && audioContext) {
        bgGain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1);
        setTimeout(() => {
          if (bgOscillator) {
            bgOscillator.stop();
            bgOscillator = null;
            bgGain = null;
            musicStarted = false;
          }
        }, 1100);
        console.log('🔇 Musique arrêtée');
      }
    }
    
    // ===== BOUTON TOGGLE =====
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = document.getElementById('audioIcon');
    
    function updateUI() {
      audioIcon.textContent = audioEnabled ? '🔊' : '🔇';
      audioToggle.classList.toggle('muted', !audioEnabled);
    }
    
    updateUI();
    
    audioToggle.addEventListener('click', (e) => {
      e.preventDefault();
      initAudio(); // Initialiser si pas encore fait
      
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      updateUI();
      
      audioToggle.style.transform = 'scale(0.9) rotate(15deg)';
      setTimeout(() => { audioToggle.style.transform = ''; }, 200);
      
      if (audioEnabled) {
        startBgMusic();
        playDropSound(); // Test
      } else {
        stopBgMusic();
      }
    });
    
    // ===== INITIALISATION AUTO AU CLIC =====
    let firstClick = false;
    document.addEventListener('click', () => {
      if (!firstClick) {
        firstClick = true;
        initAudio();
        if (audioEnabled && !musicStarted) {
          startBgMusic();
        }
      }
    }, { once: true });
    
    // ===== DONNÉES JEU =====
    const gd = document.getElementById('gameData');
    const game = {
      isAI: gd.dataset.aiMode === 'true',
      player: parseInt(gd.dataset.currentPlayer),
      over: gd.dataset.gameOver === 'true',
      winner: parseInt(gd.dataset.winner),
      sound: gd.dataset.soundToPlay,
      diff: gd.dataset.aiDifficulty,
      history: parseInt(gd.dataset.hasHistory)
    };
    
    console.log('🎮 Jeu:', game);
    
    // ===== JOUER SONS AU CHARGEMENT =====
    window.addEventListener('load', () => {
      setTimeout(() => {
        // Son drop si dernier coup (pas fin de partie)
        if (game.history > 0 && !game.over) {
          playDropSound();
        }
        
        // Sons de fin
        if (game.sound === 'win' && game.over) {
          setTimeout(() => {
            if (game.winner === 1) {
              playWinSound();
            } else if (game.winner === 2 && !game.isAI) {
              playWinSound();
            } else if (game.winner === 2 && game.isAI) {
              playLoseSound();
            }
          }, 800);
        }
      }, 400);
    });
    
    // ===== IA =====
    const aiOverlay = document.getElementById('aiThinking');
    const aiText = document.getElementById('aiSubText');
    const forms = document.querySelectorAll('.cell-form');
    
    const msgs = {
      facile: ['Je choisis au hasard...', 'Voyons voir...'],
      moyen: ['J\'analyse...', 'Calcul en cours...'],
      difficile: ['Analyse approfondie...', 'Simulation avancée...']
    };
    
    const params = new URLSearchParams(window.location.search);
    if (params.get('ai_thinking') === 'true' && game.isAI && !game.over) {
      const m = msgs[game.diff] || msgs.moyen;
      aiText.textContent = m[Math.floor(Math.random() * m.length)];
      aiOverlay.style.display = 'flex';
      
      forms.forEach(f => f.style.pointerEvents = 'none');
      
      const delays = { facile: 800, moyen: 1200, difficile: 1800 };
      const delay = delays[game.diff] || 1200;
      
      setTimeout(() => {
        fetch('/ai-play', { method: 'POST' })
          .then(() => {
            setTimeout(() => { window.location.href = '/game'; }, 300);
          })
          .catch(() => { window.location.href = '/game'; });
      }, delay);
    }
    
    // ===== FORMULAIRES =====
    forms.forEach(form => {
      form.addEventListener('submit', () => {
        initAudio();
        playDropSound();
        forms.forEach(f => f.style.pointerEvents = 'none');
        form.querySelector('.cell').style.transform = 'scale(0.95)';
      });
    });
    
    // Bloquer si tour IA
    if (game.isAI && game.player === 2 && !game.over) {
      forms.forEach(f => f.style.pointerEvents = 'none');
    }
    
    // ===== HOVER =====
    forms.forEach(form => {
      const col = form.dataset.column;
      const btn = form.querySelector('.cell');
      
      btn.addEventListener('mouseenter', () => {
        if (!btn.disabled && !game.over) {
          forms.forEach(f => {
            if (f.dataset.column === col) {
              f.querySelector('.cell').classList.add('hover-column');
            }
          });
        }
      });
      
      btn.addEventListener('mouseleave', () => {
        forms.forEach(f => {
          f.querySelector('.cell').classList.remove('hover-column');
        });
      });
    });
    
    console.log('✅ Chargé');
  </script>
</body>
</html>