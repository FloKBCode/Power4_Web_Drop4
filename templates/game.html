<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puissance 4 - Scores Néon</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <!-- BOUTON RETOUR MENU -->
  <a href="/" class="menu-btn">⬅️ Menu</a>

  <!-- CONTRÔLE AUDIO -->
  <button id="audioToggle" class="audio-toggle">🔊</button>

  <h1>🎮 Puissance 4 🎮</h1>
  
  <!-- TABLEAU DE SCORES NÉON avec pseudos du backend -->
  <div class="scoreboard neon">
    <div class="player-label red">{{.Player1Name}}</div>
    <div class="score-value">{{.ScoreP1}}</div>
    <div class="score-separator">-</div>
    <div class="score-value">{{.ScoreP2}}</div>
    <div class="player-label yellow">{{.Player2Name}}</div>
  </div>

  <!-- INFO JOUEUR avec pseudo dynamique -->
  {{if .GameOver}}
    {{if eq .Winner 0}}
      <div class="player-info">⚖️ Match nul !</div>
    {{else}}
      <div class="player-info winner">🏆 {{.GetWinnerName}} a gagné ! 🏆</div>
    {{end}}
  {{else}}
    <div class="player-info">Au tour de {{.GetCurrentPlayerName}}</div>
  {{end}}
  
  <!-- Message d'erreur -->
  {{if .ErrorMessage}}
    <div class="error-message">{{.ErrorMessage}}</div>
  {{end}}
  
  <!-- OVERLAY AI THINKING -->
  <div id="aiThinking" class="ai-thinking-overlay" style="display: none;">
    <div class="ai-thinking-content">
      <div class="ai-thinking-spinner"></div>
      <p>🤖 L'IA réfléchit...</p>
    </div>
  </div>

  <!-- GRILLE DE JEU -->
  <div class="game-container">
    <div class="grid">
      {{range $i := Seq 6}}
        {{range $j := Seq 7}}
          <form method="POST" action="/play" style="margin: 0; padding: 0;" class="cell-form" data-column="{{$j}}">
            <input type="hidden" name="column" value="{{$j}}">
            <button type="submit" class="cell" {{if $.GameOver}}disabled{{end}} {{if IsColumnFull $j}}disabled{{end}}>
              {{$cellValue := $.GetCell $i $j}}
              {{if eq $cellValue 1}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token red {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active{{end}}"></div>
              {{else if eq $cellValue 2}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token yellow {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active{{end}}"></div>
              {{end}}
            </button>
          </form>
        {{end}}
      {{end}}
    </div>

    <!-- Historique des coups -->
    {{if .History}}
    <div class="history-panel">
      <h3>📜 Historique</h3>
      <div class="history-list">
        {{range $index, $move := .History}}
          <div class="history-item">
            #{{add $index 1}} - 
            {{if eq $move.Player 1}}🔴{{else}}🟡{{end}}
            Col {{add $move.Column 1}}
          </div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  <!-- BOUTONS DE CONTRÔLE -->
  <div class="button-container">
    <form method="POST" action="/reset" style="margin: 0;">
      <button type="submit" class="reset-btn">🔄 Nouvelle Partie</button>
    </form>
    <form method="POST" action="/reset-scores" style="margin: 0;">
      <button type="submit" class="score-reset-btn">📊 Reset Scores</button>
    </form>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="bgMusic" loop>
    <source src="/static/sounds/background.mp3" type="audio/mpeg">
  </audio>
  <audio id="dropSound">
    <source src="/static/sounds/drop.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound">
    <source src="/static/sounds/win.mp3" type="audio/mpeg">
  </audio>
  <audio id="loseSound">
    <source src="/static/sounds/lose.mp3" type="audio/mpeg">
  </audio>
  <audio id="drawSound">
    <source src="/static/sounds/draw.mp3" type="audio/mpeg">
  </audio>
  <audio id="errorSound">
    <source src="/static/sounds/error.mp3" type="audio/mpeg">
  </audio>

  <div id="gameData"
     data-ai-mode="{{if .AIMode}}true{{else}}false{{end}}"
     data-current-player="{{if .Player}}{{.Player}}{{else}}1{{end}}"
     data-game-over="{{if .GameOver}}true{{else}}false{{end}}"
     data-winner="{{if .Winner}}{{.Winner}}{{else}}0{{end}}"
     data-sound-to-play="{{.SoundToPlay}}"
     data-error="{{if .ErrorMessage}}1{{else}}0{{end}}"></div>
  </div>

  <script>
    // === GESTION AUDIO ===
    const bgMusic = document.getElementById('bgMusic');
    const dropSound = document.getElementById('dropSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');
    const drawSound = document.getElementById('drawSound');
    const errorSound = document.getElementById('errorSound');
    const audioToggle = document.getElementById('audioToggle');
    
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    
    // Initialiser l'état audio
    if (audioEnabled) {
      audioToggle.textContent = '🔊';
      bgMusic.volume = 0.3;
      bgMusic.play().catch(e => console.log('Autoplay bloqué:', e));
    } else {
      audioToggle.textContent = '🔇';
      bgMusic.pause();
    }

    // Toggle audio
    audioToggle.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      
      if (audioEnabled) {
        audioToggle.textContent = '🔊';
        bgMusic.play().catch(e => console.log('Play error:', e));
      } else {
        audioToggle.textContent = '🔇';
        bgMusic.pause();
      }
    });

    function playSound(sound) {
      if (audioEnabled && sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log('Sound error:', e));
      }
    }

    // === SONS BASÉS SUR L'ÉTAT DU JEU ===
    const gameDataEl = document.getElementById('gameData');
    const gameState = {
      isAIMode: gameDataEl.dataset.aiMode === 'true',
      currentPlayer: Number(gameDataEl.dataset.currentPlayer),
      gameOver: gameDataEl.dataset.gameOver === 'true',
      winner: Number(gameDataEl.dataset.winner),
      soundToPlay: gameDataEl.dataset.soundToPlay || ""
    };

    const isAIMode = gameState.isAIMode;
    const currentPlayer = gameState.currentPlayer;
    const gameOver = gameState.gameOver;
    const winner = gameState.winner;
    const soundToPlay = gameState.soundToPlay;

    // Jouer les sons de fin de partie
    window.addEventListener('load', () => {
      if (soundToPlay === "win") {
        setTimeout(() => {
          if (winner === 1) {
            playSound(winSound);
          } else if (winner === 2 && !isAIMode) {
            playSound(winSound);
          } else if (winner === 2 && isAIMode) {
            playSound(loseSound);
          }
        }, 600);
      } else if (soundToPlay === "draw") {
        setTimeout(() => playSound(drawSound), 600);
      }
    });

    // === GESTION DES FORMULAIRES ===
    const aiThinking = document.getElementById('aiThinking');
    const forms = document.querySelectorAll('.cell-form');
    
    forms.forEach(form => {
      form.addEventListener('submit', (e) => {
        playSound(dropSound);
        forms.forEach(f => f.style.pointerEvents = 'none');
        
        if (isAIMode && !gameOver && currentPlayer === 1) {
          setTimeout(() => {
            aiThinking.style.display = 'flex';
          }, 500);
        }
      });
    });

    // === GESTION DES ERREURS ===
  // Lire l'indicateur d'erreur depuis les data-attributes (aucune directive Go dans le script)
  const hasError = gameDataEl.dataset.error === '1';
  if (hasError) {
    playSound(errorSound);
  }

    // Empêcher les clics multiples pendant que l'IA réfléchit
    if (isAIMode && currentPlayer === 2 && !gameOver) {
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
      aiThinking.style.display = 'flex';
    }
  </script>
</body>
</html>
