<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puissance 4 - En jeu</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* Repositionner le bouton audio en haut √† droite */
    .audio-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .audio-toggle:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .audio-toggle:active {
      transform: translateY(-1px) scale(0.95);
    }

    .audio-icon {
      font-size: 1.8em;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      transition: transform 0.3s ease;
    }

    .audio-toggle.muted {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .audio-toggle.muted .audio-icon {
      opacity: 0.6;
    }

    /* Am√©liorer l'overlay IA */
    .ai-thinking-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeInOverlay 0.3s ease;
    }

    @keyframes fadeInOverlay {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .ai-thinking-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 50px 70px;
      border-radius: 25px;
      text-align: center;
      box-shadow: 0 0 60px rgba(102, 126, 234, 0.8),
                  0 0 100px rgba(118, 75, 162, 0.6);
      animation: slideUpBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      max-width: 90%;
      border: 3px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideUpBounce {
      0% { 
        transform: translateY(100px) scale(0.8); 
        opacity: 0; 
      }
      60% { 
        transform: translateY(-10px) scale(1.02); 
      }
      100% { 
        transform: translateY(0) scale(1); 
        opacity: 1; 
      }
    }

    .ai-brain-container {
      position: relative;
      margin-bottom: 25px;
    }

    .ai-brain {
      font-size: 5em;
      animation: brainPulse 1.5s ease-in-out infinite;
      display: inline-block;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    }

    @keyframes brainPulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.05) rotate(-5deg); }
      75% { transform: scale(1.05) rotate(5deg); }
    }

    .thinking-dots {
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }

    .dot {
      font-size: 2em;
      color: white;
      animation: dotBounce 1.4s ease-in-out infinite;
      opacity: 0;
    }

    .dot:nth-child(1) { animation-delay: 0s; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotBounce {
      0%, 80%, 100% { 
        opacity: 0; 
        transform: translateY(0); 
      }
      40% { 
        opacity: 1; 
        transform: translateY(-10px); 
      }
    }

    .ai-thinking-text {
      margin: 20px 0;
    }

    .ai-main-text {
      color: white;
      font-size: 1.8em;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      letter-spacing: 1px;
    }

    .ai-sub-text {
      color: rgba(255, 255, 255, 0.95);
      font-size: 1.2em;
      font-style: italic;
      margin: 0;
      min-height: 1.5em;
      animation: textFade 0.5s ease;
    }

    @keyframes textFade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 25px;
    }

    .progress-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #fff, #FFD700, #fff);
      border-radius: 10px;
      animation: progressSlide 2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
    }

    @keyframes progressSlide {
      0% { 
        width: 0%; 
        transform: translateX(0);
      }
      50% { 
        width: 100%; 
        transform: translateX(0);
      }
      100% { 
        width: 0%; 
        transform: translateX(100%);
      }
    }

    /* === ACCESSIBILIT√â === */
    
    /* Mode r√©duit d'animations pour utilisateurs sensibles */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      
      .token.last-move,
      .token.winning {
        animation: none !important;
      }
      
      .ai-thinking-overlay,
      .ai-thinking-content {
        animation: none !important;
      }
    }

    /* Am√©lioration contrastes pour malvoyants */
    @media (prefers-contrast: high) {
      .scoreboard.neon {
        border-width: 3px;
        border-color: #00ffff;
      }
      
      .token.red {
        background: #ff0000;
        border: 3px solid #000;
      }
      
      .token.yellow {
        background: #ffff00;
        border: 3px solid #000;
      }
      
      .cell {
        border-width: 4px;
      }
    }

    /* Navigation clavier am√©lior√©e */
    .cell:focus-visible,
    .reset-btn:focus-visible,
    .score-reset-btn:focus-visible,
    .menu-btn:focus-visible,
    .audio-toggle:focus-visible {
      outline: 4px solid #FFD700;
      outline-offset: 4px;
      box-shadow: 0 0 0 6px rgba(255, 215, 0, 0.3);
    }

    /* Skip to main content pour lecteurs d'√©cran */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: #667eea;
      color: white;
      padding: 8px;
      text-decoration: none;
      z-index: 10000;
    }

    .skip-link:focus {
      top: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .audio-toggle {
        top: 10px;
        right: 10px;
        width: 55px;
        height: 55px;
      }
      
      .audio-icon {
        font-size: 1.5em;
      }

      .ai-thinking-content {
        padding: 40px 50px;
      }

      .ai-brain {
        font-size: 4em;
      }

      .ai-main-text {
        font-size: 1.5em;
      }

      .ai-sub-text {
        font-size: 1.1em;
      }
    }

    @media (max-width: 480px) {
      .audio-toggle {
        width: 50px;
        height: 50px;
      }

      .audio-icon {
        font-size: 1.4em;
      }

      .ai-thinking-content {
        padding: 30px 35px;
      }

      .ai-brain {
        font-size: 3em;
      }

      .ai-main-text {
        font-size: 1.3em;
      }

      .ai-sub-text {
        font-size: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- BOUTON RETOUR MENU -->
  <a href="/" class="menu-btn">
    <span class="menu-icon">‚¨ÖÔ∏è</span>
    <span class="menu-text">Menu</span>
  </a>

  <!-- CONTR√îLE AUDIO -->
  <button id="audioToggle" class="audio-toggle" title="Activer/D√©sactiver le son" aria-label="Toggle audio">
    <span id="audioIcon" class="audio-icon">üîä</span>
  </button>

  <h1>üéÆ Puissance 4 üéÆ</h1>
  
  <!-- TABLEAU DE SCORES N√âON -->
  <div class="scoreboard neon">
    <div class="player-label red">{{.Player1Name}}</div>
    <div class="score-value">{{.ScoreP1}}</div>
    <div class="score-separator">-</div>
    <div class="score-value">{{.ScoreP2}}</div>
    <div class="player-label yellow">{{.Player2Name}}</div>
  </div>

  <!-- STATISTIQUES -->
  <div class="stats-container">
    <div class="stat-box">
      <div class="stat-label">Parties jou√©es</div>
      <div class="stat-value">{{.GamesPlayed}}</div>
    </div>
    {{if .AIMode}}
    <div class="stat-box ai-difficulty">
      <div class="stat-label">Difficult√© IA</div>
      <div class="stat-value difficulty-{{.AIDifficulty}}">
        {{if eq .AIDifficulty "facile"}}üòä Facile{{end}}
        {{if eq .AIDifficulty "moyen"}}ü§î Moyen{{end}}
        {{if eq .AIDifficulty "difficile"}}üòà Difficile{{end}}
      </div>
    </div>
    {{end}}
  </div>

  <!-- INFO JOUEUR -->
  {{if .GameOver}}
    {{if eq .Winner 0}}
      <div class="player-info draw-message">
        <span class="info-icon">‚öñÔ∏è</span>
        <span class="info-text">Match nul !</span>
      </div>
    {{else}}
      <div class="player-info winner">
        <span class="trophy-icon">üèÜ</span>
        <span class="winner-text">{{.GetWinnerName}} a gagn√© !</span>
        <span class="trophy-icon">üèÜ</span>
      </div>
    {{end}}
  {{else}}
    <div class="player-info current-turn">
      <span class="turn-indicator"></span>
      <span class="turn-text">Au tour de <strong>{{.GetCurrentPlayerName}}</strong></span>
    </div>
  {{end}}
  
  <!-- Message d'erreur -->
  {{if .ErrorMessage}}
    <div class="error-message">
      <span class="error-icon">‚ö†Ô∏è</span>
      {{.ErrorMessage}}
    </div>
  {{end}}
  
  <!-- OVERLAY IA -->
  <div id="aiThinking" class="ai-thinking-overlay">
    <div class="ai-thinking-content">
      <div class="ai-brain-container">
        <div class="ai-brain">ü§ñ</div>
        <div class="thinking-dots">
          <span class="dot">.</span>
          <span class="dot">.</span>
          <span class="dot">.</span>
        </div>
      </div>
      <div class="ai-thinking-text">
        <p class="ai-main-text">L'ordinateur r√©fl√©chit</p>
        <p class="ai-sub-text" id="aiSubText">Analyse du plateau...</p>
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- GRILLE DE JEU -->
  <div class="game-container">
    <div class="grid">
      {{range $i := Seq 6}}
        {{range $j := Seq 7}}
          <form method="POST" action="/play" style="margin: 0; padding: 0;" class="cell-form" data-column="{{$j}}">
            <input type="hidden" name="column" value="{{$j}}">
            <button type="submit" class="cell" {{if $.GameOver}}disabled{{end}} {{if IsColumnFull $j}}disabled{{end}}>
              {{$cellValue := $.GetCell $i $j}}
              {{if eq $cellValue 1}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token red {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{else if eq $cellValue 2}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token yellow {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{end}}
            </button>
          </form>
        {{end}}
      {{end}}
    </div>

    <!-- Historique des coups -->
    {{if .History}}
    <div class="history-panel">
      <h3>üìú Historique des coups</h3>
      <div class="history-stats">
        <span>Total: {{len .History}} coups</span>
      </div>
      <div class="history-list">
        {{range $index, $move := .History}}
          <div class="history-item {{if eq $index (sub (len $.History) 1)}}last-move{{end}}">
            <span class="move-number">#{{add $index 1}}</span>
            <span class="move-player">{{if eq $move.Player 1}}üî¥{{else}}üü°{{end}}</span>
            <span class="move-column">Colonne {{add $move.Column 1}}</span>
          </div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  <!-- BOUTONS DE CONTR√îLE -->
  <div class="button-container">
    <form method="POST" action="/reset" style="margin: 0;">
      <button type="submit" class="reset-btn">
        <span class="btn-icon">üîÑ</span>
        <span class="btn-text">Nouvelle Partie</span>
      </button>
    </form>
    <form method="POST" action="/reset-scores" style="margin: 0;">
      <button type="submit" class="score-reset-btn">
        <span class="btn-icon">üìä</span>
        <span class="btn-text">Reset Scores</span>
      </button>
    </form>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="dropSound" preload="auto">
    <source src="/static/sounds/drop.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="/static/sounds/win.mp3" type="audio/mpeg">
  </audio>
  <audio id="loseSound" preload="auto">
    <source src="/static/sounds/lose.mp3" type="audio/mpeg">
  </audio>

  <div id="gameData"
     data-ai-mode="{{if .AIMode}}true{{else}}false{{end}}"
     data-current-player="{{if .Player}}{{.Player}}{{else}}1{{end}}"
     data-game-over="{{if .GameOver}}true{{else}}false{{end}}"
     data-winner="{{if .Winner}}{{.Winner}}{{else}}0{{end}}"
     data-sound-to-play="{{.SoundToPlay}}"
     data-ai-difficulty="{{.AIDifficulty}}"
     data-error="{{if .ErrorMessage}}1{{else}}0{{end}}">
  </div>

  <script>
    // === GESTION AUDIO ===
    const dropSound = document.getElementById('dropSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = document.getElementById('audioIcon');
    
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    let userInteracted = false;
    
    // D√©tecter la premi√®re interaction utilisateur
    function enableAudio() {
      if (!userInteracted) {
        userInteracted = true;
        document.removeEventListener('click', enableAudio);
        document.removeEventListener('keydown', enableAudio);
      }
    }
    
    document.addEventListener('click', enableAudio);
    document.addEventListener('keydown', enableAudio);
    
    // Initialiser l'√©tat audio
    function updateAudioState() {
      if (audioEnabled) {
        audioIcon.textContent = 'üîä';
        audioToggle.classList.remove('muted');
      } else {
        audioIcon.textContent = 'üîá';
        audioToggle.classList.add('muted');
      }
    }
    
    updateAudioState();

    // Toggle audio
    audioToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      
      audioToggle.style.transform = 'scale(0.85) rotate(15deg)';
      setTimeout(() => {
        audioToggle.style.transform = '';
      }, 200);
      
      updateAudioState();
    });

    // Jouer un son
    function playSound(sound, volume = 0.5) {
      if (audioEnabled && sound && userInteracted) {
        sound.currentTime = 0;
        sound.volume = volume;
        sound.play().catch(e => console.log('Erreur son:', e.message));
      }
    }

    // === DONN√âES DU JEU ===
    const gameDataEl = document.getElementById('gameData');
    const gameState = {
      isAIMode: gameDataEl.dataset.aiMode === 'true',
      currentPlayer: Number(gameDataEl.dataset.currentPlayer),
      gameOver: gameDataEl.dataset.gameOver === 'true',
      winner: Number(gameDataEl.dataset.winner),
      soundToPlay: gameDataEl.dataset.soundToPlay || "",
      aiDifficulty: gameDataEl.dataset.aiDifficulty || "moyen",
      hasError: gameDataEl.dataset.error === '1'
    };

    const isAIMode = gameState.isAIMode;
    const currentPlayer = gameState.currentPlayer;
    const gameOver = gameState.gameOver;
    const winner = gameState.winner;
    const soundToPlay = gameState.soundToPlay;

    // === JOUER LES SONS DE FIN DE PARTIE ===
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (soundToPlay === "win") {
          // Victoire joueur 1 en PvP ou victoire contre IA
          if (winner === 1 || (winner === 1 && isAIMode)) {
            playSound(winSound, 0.6);
          } 
          // Victoire joueur 2 en PvP
          else if (winner === 2 && !isAIMode) {
            playSound(winSound, 0.6);
          } 
          // D√©faite contre l'IA
          else if (winner === 2 && isAIMode) {
            playSound(loseSound, 0.5);
          }
        }
      }, 800);
    });

    // === GESTION DES FORMULAIRES ET IA ===
    const aiThinking = document.getElementById('aiThinking');
    const aiSubText = document.getElementById('aiSubText');
    const forms = document.querySelectorAll('.cell-form');
    
    // Messages pour l'IA
    const aiMessages = {
      facile: [
        "Je choisis au hasard...",
        "Voyons voir...",
        "Hmm, quelle colonne ?",
        "Eeny, meeny, miny, moe..."
      ],
      moyen: [
        "J'analyse les possibilit√©s...",
        "Calcul de la meilleure strat√©gie...",
        "√âvaluation des menaces...",
        "Recherche du coup optimal..."
      ],
      difficile: [
        "Analyse approfondie en cours...",
        "Calcul des probabilit√©s de victoire...",
        "Simulation de plusieurs coups √† l'avance...",
        "Optimisation strat√©gique maximale..."
      ]
    };
    
    // V√©rifier si l'IA doit jouer
    const urlParams = new URLSearchParams(window.location.search);
    const aiShouldThink = urlParams.get('ai_thinking') === 'true';
    
    if (aiShouldThink && isAIMode && !gameOver) {
      const messages = aiMessages[gameState.aiDifficulty] || aiMessages.moyen;
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      aiSubText.textContent = randomMessage;
      
      aiThinking.style.display = 'flex';
      
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
      
      const thinkingDelay = getAIThinkingDelay(gameState.aiDifficulty);
      
      setTimeout(() => {
        fetch('/ai-play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        }).then(() => {
          playSound(dropSound, 0.5);
          
          setTimeout(() => {
            window.location.href = '/game';
          }, 400);
        }).catch(err => {
          console.error('Erreur IA:', err);
          window.location.href = '/game';
        });
      }, thinkingDelay);
    } else {
      aiThinking.style.display = 'none';
    }
    
    function getAIThinkingDelay(difficulty) {
      switch(difficulty) {
        case 'facile': return 600 + Math.random() * 400;
        case 'moyen': return 1000 + Math.random() * 500;
        case 'difficile': return 1500 + Math.random() * 800;
        default: return 1000;
      }
    }
    
    // G√©rer la soumission des formulaires
    forms.forEach(form => {
      form.addEventListener('submit', (e) => {
        playSound(dropSound, 0.5);
        
        forms.forEach(f => f.style.pointerEvents = 'none');
        
        const button = form.querySelector('.cell');
        button.style.transform = 'scale(0.95)';
      });
    });

    // Emp√™cher les interactions si c'est au tour de l'IA
    if (isAIMode && currentPlayer === 2 && !gameOver) {
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
    }

    // Hover effect sur les colonnes
    forms.forEach((form, index) => {
      const col = form.dataset.column;
      const button = form.querySelector('.cell');
      
      button.addEventListener('mouseenter', () => {
        if (!button.disabled && !gameOver) {
          forms.forEach(f => {
            if (f.dataset.column === col) {
              f.querySelector('.cell').classList.add('hover-column');
            }
          });
        }
      });
      
      button.addEventListener('mouseleave', () => {
        forms.forEach(f => {
          f.querySelector('.cell').classList.remove('hover-column');
        });
      });
    });
  </script>
</body>
</html>