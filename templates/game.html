<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puissance 4 - En jeu</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <!-- BOUTON RETOUR MENU -->
  <a href="/" class="menu-btn">
    <span class="menu-icon">⬅️</span>
    <span class="menu-text">Menu</span>
  </a>

  <!-- CONTRÔLE AUDIO AMÉLIORÉ -->
  <button id="audioToggle" class="audio-toggle" title="Activer/Désactiver la musique" aria-label="Toggle audio">
    <div class="audio-icon-container">
      <span id="audioIcon" class="audio-icon">🔊</span>
      <div class="audio-wave wave1"></div>
      <div class="audio-wave wave2"></div>
      <div class="audio-wave wave3"></div>
    </div>
  </button>

  <h1>🎮 Puissance 4 🎮</h1>
  
  <!-- TABLEAU DE SCORES NÉON -->
  <div class="scoreboard neon">
    <div class="player-label red">{{.Player1Name}}</div>
    <div class="score-value">{{.ScoreP1}}</div>
    <div class="score-separator">-</div>
    <div class="score-value">{{.ScoreP2}}</div>
    <div class="player-label yellow">{{.Player2Name}}</div>
  </div>

  <!-- STATISTIQUES -->
  <div class="stats-container">
    <div class="stat-box">
      <div class="stat-label">Parties jouées</div>
      <div class="stat-value">{{.GamesPlayed}}</div>
    </div>
    {{if .AIMode}}
    <div class="stat-box ai-difficulty">
      <div class="stat-label">Difficulté IA</div>
      <div class="stat-value difficulty-{{.AIDifficulty}}">
        {{if eq .AIDifficulty "facile"}}😊 Facile{{end}}
        {{if eq .AIDifficulty "moyen"}}🤔 Moyen{{end}}
        {{if eq .AIDifficulty "difficile"}}😈 Difficile{{end}}
      </div>
    </div>
    {{end}}
  </div>

  <!-- INFO JOUEUR -->
  {{if .GameOver}}
    {{if eq .Winner 0}}
      <div class="player-info draw-message">
        <span class="info-icon">⚖️</span>
        <span class="info-text">Match nul !</span>
      </div>
    {{else}}
      <div class="player-info winner">
        <span class="trophy-icon">🏆</span>
        <span class="winner-text">{{.GetWinnerName}} a gagné !</span>
        <span class="trophy-icon">🏆</span>
      </div>
    {{end}}
  {{else}}
    <div class="player-info current-turn">
      <span class="turn-indicator"></span>
      <span class="turn-text">Au tour de <strong>{{.GetCurrentPlayerName}}</strong></span>
    </div>
  {{end}}
  
  <!-- Message d'erreur -->
  {{if .ErrorMessage}}
    <div class="error-message">
      <span class="error-icon">⚠️</span>
      {{.ErrorMessage}}
    </div>
  {{end}}
  
  <!-- OVERLAY IA AMÉLIORÉ -->
  <div id="aiThinking" class="ai-thinking-overlay">
    <div class="ai-thinking-content">
      <div class="ai-brain-container">
        <div class="ai-brain">🤖</div>
        <div class="thinking-dots">
          <span class="dot">.</span>
          <span class="dot">.</span>
          <span class="dot">.</span>
        </div>
      </div>
      <div class="ai-thinking-text">
        <p class="ai-main-text">L'ordinateur réfléchit</p>
        <p class="ai-sub-text" id="aiSubText">Analyse du plateau...</p>
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
  </div>

  <!-- GRILLE DE JEU -->
  <div class="game-container">
    <div class="grid">
      {{range $i := Seq 6}}
        {{range $j := Seq 7}}
          <form method="POST" action="/play" style="margin: 0; padding: 0;" class="cell-form" data-column="{{$j}}">
            <input type="hidden" name="column" value="{{$j}}">
            <button type="submit" class="cell" {{if $.GameOver}}disabled{{end}} {{if IsColumnFull $j}}disabled{{end}}>
              {{$cellValue := $.GetCell $i $j}}
              {{if eq $cellValue 1}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token red {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{else if eq $cellValue 2}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token yellow {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active winning{{end}}"></div>
              {{end}}
            </button>
          </form>
        {{end}}
      {{end}}
    </div>

    <!-- Historique des coups -->
    {{if .History}}
    <div class="history-panel">
      <h3>📜 Historique des coups</h3>
      <div class="history-stats">
        <span>Total: {{len .History}} coups</span>
      </div>
      <div class="history-list">
        {{range $index, $move := .History}}
          <div class="history-item {{if eq $index (sub (len $.History) 1)}}last-move{{end}}">
            <span class="move-number">#{{add $index 1}}</span>
            <span class="move-player">{{if eq $move.Player 1}}🔴{{else}}🟡{{end}}</span>
            <span class="move-column">Colonne {{add $move.Column 1}}</span>
          </div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  <!-- BOUTONS DE CONTRÔLE -->
  <div class="button-container">
    <form method="POST" action="/reset" style="margin: 0;">
      <button type="submit" class="reset-btn">
        <span class="btn-icon">🔄</span>
        <span class="btn-text">Nouvelle Partie</span>
      </button>
    </form>
    <form method="POST" action="/reset-scores" style="margin: 0;">
      <button type="submit" class="score-reset-btn">
        <span class="btn-icon">📊</span>
        <span class="btn-text">Reset Scores</span>
      </button>
    </form>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="bgMusic" loop preload="auto">
    <source src="/static/sounds/background.mp3" type="audio/mpeg">
  </audio>
  <audio id="dropSound" preload="auto">
    <source src="/static/sounds/drop.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="/static/sounds/win.mp3" type="audio/mpeg">
  </audio>
  <audio id="loseSound" preload="auto">
    <source src="/static/sounds/lose.mp3" type="audio/mpeg">
  </audio>
  <audio id="errorSound" preload="auto">
    <source src="/static/sounds/error.mp3" type="audio/mpeg">
  </audio>

  <div id="gameData"
     data-ai-mode="{{if .AIMode}}true{{else}}false{{end}}"
     data-current-player="{{if .Player}}{{.Player}}{{else}}1{{end}}"
     data-game-over="{{if .GameOver}}true{{else}}false{{end}}"
     data-winner="{{if .Winner}}{{.Winner}}{{else}}0{{end}}"
     data-sound-to-play="{{.SoundToPlay}}"
     data-ai-difficulty="{{.AIDifficulty}}"
     data-error="{{if .ErrorMessage}}1{{else}}0{{end}}">
  </div>

  <script>
    // === GESTION AUDIO PERFECTIONNÉE ===
    const bgMusic = document.getElementById('bgMusic');
    const dropSound = document.getElementById('dropSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');
    const errorSound = document.getElementById('errorSound');
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = document.getElementById('audioIcon');
    
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    let musicStarted = false;
    let userInteracted = false;
    
    // Fonction pour démarrer la musique
    function startMusic() {
      if (!musicStarted && audioEnabled && userInteracted) {
        bgMusic.volume = 0.25;
        bgMusic.play().then(() => {
          musicStarted = true;
          console.log('✅ Musique de fond démarrée');
        }).catch(e => {
          console.log('⚠️ Autoplay bloqué par le navigateur');
        });
      }
    }
    
    // Détecter la première interaction utilisateur
    function enableAudio() {
      if (!userInteracted) {
        userInteracted = true;
        startMusic();
        document.removeEventListener('click', enableAudio);
        document.removeEventListener('keydown', enableAudio);
      }
    }
    
    document.addEventListener('click', enableAudio);
    document.addEventListener('keydown', enableAudio);
    
    // Initialiser l'état audio
    function updateAudioState() {
      if (audioEnabled) {
        audioIcon.textContent = '🔊';
        audioToggle.classList.remove('muted');
        audioToggle.classList.add('active');
        if (userInteracted) {
          startMusic();
        }
      } else {
        audioIcon.textContent = '🔇';
        audioToggle.classList.remove('active');
        audioToggle.classList.add('muted');
        bgMusic.pause();
        musicStarted = false;
      }
    }
    
    updateAudioState();

    // Toggle audio avec animation
    audioToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      
      // Animation du bouton
      audioToggle.style.transform = 'scale(0.85) rotate(15deg)';
      setTimeout(() => {
        audioToggle.style.transform = '';
      }, 200);
      
      updateAudioState();
    });

    // Jouer un son avec gestion d'erreur
    function playSound(sound, volume = 0.5) {
      if (audioEnabled && sound && userInteracted) {
        sound.currentTime = 0;
        sound.volume = volume;
        sound.play().catch(e => console.log('Erreur son:', e.message));
      }
    }

    // === DONNÉES DU JEU ===
    const gameDataEl = document.getElementById('gameData');
    const gameState = {
      isAIMode: gameDataEl.dataset.aiMode === 'true',
      currentPlayer: Number(gameDataEl.dataset.currentPlayer),
      gameOver: gameDataEl.dataset.gameOver === 'true',
      winner: Number(gameDataEl.dataset.winner),
      soundToPlay: gameDataEl.dataset.soundToPlay || "",
      aiDifficulty: gameDataEl.dataset.aiDifficulty || "moyen",
      hasError: gameDataEl.dataset.error === '1'
    };

    const isAIMode = gameState.isAIMode;
    const currentPlayer = gameState.currentPlayer;
    const gameOver = gameState.gameOver;
    const winner = gameState.winner;
    const soundToPlay = gameState.soundToPlay;

    // === JOUER LES SONS DE FIN DE PARTIE ===
    window.addEventListener('load', () => {
      // Attendre un peu pour que l'utilisateur voie l'animation
      setTimeout(() => {
        // Son de victoire/défaite
        if (soundToPlay === "win") {
          if (winner === 1) {
            playSound(winSound, 0.6);
          } else if (winner === 2 && !isAIMode) {
            playSound(winSound, 0.6);
          } else if (winner === 2 && isAIMode) {
            playSound(loseSound, 0.5);
          }
        }
        
        // Son d'erreur
        if (gameState.hasError) {
          playSound(errorSound, 0.4);
        }
      }, 800);
    });

    // === GESTION DES FORMULAIRES ET IA ===
    const aiThinking = document.getElementById('aiThinking');
    const aiSubText = document.getElementById('aiSubText');
    const forms = document.querySelectorAll('.cell-form');
    
    // Messages aléatoires pour l'IA
    const aiMessages = {
      facile: [
        "Je choisis au hasard...",
        "Voyons voir...",
        "Hmm, quelle colonne ?",
        "Eeny, meeny, miny, moe..."
      ],
      moyen: [
        "J'analyse les possibilités...",
        "Calcul de la meilleure stratégie...",
        "Évaluation des menaces...",
        "Recherche du coup optimal..."
      ],
      difficile: [
        "Analyse approfondie en cours...",
        "Calcul des probabilités de victoire...",
        "Simulation de plusieurs coups à l'avance...",
        "Optimisation stratégique maximale..."
      ]
    };
    
    // Vérifier si l'IA doit jouer
    const urlParams = new URLSearchParams(window.location.search);
    const aiShouldThink = urlParams.get('ai_thinking') === 'true';
    
    if (aiShouldThink && isAIMode && !gameOver) {
      // Choisir un message aléatoire selon la difficulté
      const messages = aiMessages[gameState.aiDifficulty] || aiMessages.moyen;
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      aiSubText.textContent = randomMessage;
      
      // Afficher l'overlay
      aiThinking.style.display = 'flex';
      
      // Désactiver tous les formulaires
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
      
      // Simuler le délai de réflexion puis faire jouer l'IA
      const thinkingDelay = getAIThinkingDelay(gameState.aiDifficulty);
      
      setTimeout(() => {
        // Faire jouer l'IA côté serveur
        fetch('/ai-play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        }).then(() => {
          // Jouer le son de drop pour l'IA
          playSound(dropSound, 0.5);
          
          // Petit délai pour entendre le son
          setTimeout(() => {
            window.location.href = '/game';
          }, 400);
        }).catch(err => {
          console.error('Erreur IA:', err);
          window.location.href = '/game';
        });
      }, thinkingDelay);
    } else {
      // Masquer l'overlay
      aiThinking.style.display = 'none';
    }
    
    // Délai selon la difficulté
    function getAIThinkingDelay(difficulty) {
      switch(difficulty) {
        case 'facile': return 600 + Math.random() * 400; // 600-1000ms
        case 'moyen': return 1000 + Math.random() * 500; // 1000-1500ms
        case 'difficile': return 1500 + Math.random() * 800; // 1500-2300ms
        default: return 1000;
      }
    }
    
    // Gérer la soumission des formulaires
    forms.forEach(form => {
      form.addEventListener('submit', (e) => {
        // Jouer le son de drop
        playSound(dropSound, 0.5);
        
        // Désactiver tous les formulaires
        forms.forEach(f => f.style.pointerEvents = 'none');
        
        // Animation visuelle sur la case cliquée
        const button = form.querySelector('.cell');
        button.style.transform = 'scale(0.95)';
      });
    });

    // Empêcher les interactions si c'est au tour de l'IA
    if (isAIMode && currentPlayer === 2 && !gameOver) {
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
    }

    // Hover effect sur les colonnes
    forms.forEach((form, index) => {
      const col = form.dataset.column;
      const button = form.querySelector('.cell');
      
      button.addEventListener('mouseenter', () => {
        if (!button.disabled && !gameOver) {
          // Highlight toute la colonne
          forms.forEach(f => {
            if (f.dataset.column === col) {
              f.querySelector('.cell').classList.add('hover-column');
            }
          });
        }
      });
      
      button.addEventListener('mouseleave', () => {
        forms.forEach(f => {
          f.querySelector('.cell').classList.remove('hover-column');
        });
      });
    });

    // Empêcher la pause de la musique lors des navigation
    window.addEventListener('beforeunload', () => {
      // La musique continue car on ne la pause pas
    });
  </script>
</body>
</html>