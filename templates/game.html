<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Puissance 4 - En jeu</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <!-- BOUTON RETOUR MENU -->
  <a href="/" class="menu-btn">⬅️ Menu</a>

  <!-- CONTRÔLE AUDIO -->
  <button id="audioToggle" class="audio-toggle" title="Activer/Désactiver la musique">
    <span id="audioIcon">🔊</span>
  </button>

  <h1>🎮 Puissance 4 🎮</h1>
  
  <!-- TABLEAU DE SCORES NÉON -->
  <div class="scoreboard neon">
    <div class="player-label red">{{.Player1Name}}</div>
    <div class="score-value">{{.ScoreP1}}</div>
    <div class="score-separator">-</div>
    <div class="score-value">{{.ScoreP2}}</div>
    <div class="player-label yellow">{{.Player2Name}}</div>
  </div>

  <!-- INFO JOUEUR -->
  {{if .GameOver}}
    {{if eq .Winner 0}}
      <div class="player-info">⚖️ Match nul !</div>
    {{else}}
      <div class="player-info winner">🏆 {{.GetWinnerName}} a gagné ! 🏆</div>
    {{end}}
  {{else}}
    <div class="player-info">Au tour de {{.GetCurrentPlayerName}}</div>
  {{end}}
  
  <!-- Message d'erreur -->
  {{if .ErrorMessage}}
    <div class="error-message">{{.ErrorMessage}}</div>
  {{end}}
  
  <!-- OVERLAY IA AMÉLIORÉ -->
  <div id="aiThinking" class="ai-thinking-overlay">
    <div class="ai-thinking-content">
      <div class="ai-thinking-spinner"></div>
      <div class="ai-thinking-text">
        <p class="ai-main-text">🤖 L'ordinateur réfléchit...</p>
        <p class="ai-sub-text">Analyse en cours</p>
      </div>
    </div>
  </div>

  <!-- GRILLE DE JEU -->
  <div class="game-container">
    <div class="grid">
      {{range $i := Seq 6}}
        {{range $j := Seq 7}}
          <form method="POST" action="/play" style="margin: 0; padding: 0;" class="cell-form" data-column="{{$j}}">
            <input type="hidden" name="column" value="{{$j}}">
            <button type="submit" class="cell" {{if $.GameOver}}disabled{{end}} {{if IsColumnFull $j}}disabled{{end}}>
              {{$cellValue := $.GetCell $i $j}}
              {{if eq $cellValue 1}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token red {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active{{end}}"></div>
              {{else if eq $cellValue 2}}
                {{$isLastMove := false}}
                {{if $.History}}
                  {{$lastMove := index $.History (sub (len $.History) 1)}}
                  {{if and (eq $lastMove.Row $i) (eq $lastMove.Column $j)}}
                    {{$isLastMove = true}}
                  {{end}}
                {{end}}
                <div class="token yellow {{if $isLastMove}}last-move{{end}} {{if $.IsWinningCell $i $j}}active{{end}}"></div>
              {{end}}
            </button>
          </form>
        {{end}}
      {{end}}
    </div>

    <!-- Historique des coups -->
    {{if .History}}
    <div class="history-panel">
      <h3>📜 Historique</h3>
      <div class="history-list">
        {{range $index, $move := .History}}
          <div class="history-item {{if eq $index (sub (len $.History) 1)}}last-move{{end}}">
            #{{add $index 1}} - 
            {{if eq $move.Player 1}}🔴{{else}}🟡{{end}}
            Col {{add $move.Column 1}}
          </div>
        {{end}}
      </div>
    </div>
    {{end}}
  </div>
  
  <!-- BOUTONS DE CONTRÔLE -->
  <div class="button-container">
    <form method="POST" action="/reset" style="margin: 0;">
      <button type="submit" class="reset-btn">🔄 Nouvelle Partie</button>
    </form>
    <form method="POST" action="/reset-scores" style="margin: 0;">
      <button type="submit" class="score-reset-btn">📊 Reset Scores</button>
    </form>
  </div>

  <!-- AUDIO ELEMENTS -->
  <audio id="bgMusic" loop preload="auto">
    <source src="/static/sounds/background.mp3" type="audio/mpeg">
  </audio>
  <audio id="dropSound" preload="auto">
    <source src="/static/sounds/drop.mp3" type="audio/mpeg">
  </audio>
  <audio id="winSound" preload="auto">
    <source src="/static/sounds/win.mp3" type="audio/mpeg">
  </audio>
  <audio id="loseSound" preload="auto">
    <source src="/static/sounds/lose.mp3" type="audio/mpeg">
  </audio>
  <audio id="errorSound" preload="auto">
    <source src="/static/sounds/error.mp3" type="audio/mpeg">
  </audio>

  <div id="gameData"
     data-ai-mode="{{if .AIMode}}true{{else}}false{{end}}"
     data-current-player="{{if .Player}}{{.Player}}{{else}}1{{end}}"
     data-game-over="{{if .GameOver}}true{{else}}false{{end}}"
     data-winner="{{if .Winner}}{{.Winner}}{{else}}0{{end}}"
     data-sound-to-play="{{.SoundToPlay}}"
     data-error="{{if .ErrorMessage}}1{{else}}0{{end}}">
  </div>

  <script>
    // === GESTION AUDIO AMÉLIORÉE ===
    const bgMusic = document.getElementById('bgMusic');
    const dropSound = document.getElementById('dropSound');
    const winSound = document.getElementById('winSound');
    const loseSound = document.getElementById('loseSound');
    const errorSound = document.getElementById('errorSound');
    const audioToggle = document.getElementById('audioToggle');
    const audioIcon = document.getElementById('audioIcon');
    
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    let musicStarted = false;
    
    // Fonction pour démarrer la musique une seule fois
    function startMusic() {
      if (!musicStarted && audioEnabled) {
        bgMusic.volume = 0.3;
        bgMusic.play().then(() => {
          musicStarted = true;
          console.log('Musique démarrée');
        }).catch(e => {
          console.log('Autoplay bloqué:', e);
          // Réessayer au premier clic
          document.body.addEventListener('click', function startOnClick() {
            if (audioEnabled) {
              bgMusic.play().then(() => {
                musicStarted = true;
                document.body.removeEventListener('click', startOnClick);
              }).catch(e => console.log('Erreur lecture:', e));
            }
          }, { once: true });
        });
      }
    }
    
    // Initialiser l'état audio
    function updateAudioState() {
      if (audioEnabled) {
        audioIcon.textContent = '🔊';
        audioToggle.classList.remove('muted');
        audioToggle.classList.add('active');
        startMusic();
      } else {
        audioIcon.textContent = '🔇';
        audioToggle.classList.remove('active');
        audioToggle.classList.add('muted');
        bgMusic.pause();
      }
    }
    
    updateAudioState();

    // Toggle audio avec animation
    audioToggle.addEventListener('click', () => {
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      
      // Animation du bouton
      audioToggle.style.transform = 'scale(0.85) rotate(15deg)';
      setTimeout(() => {
        audioToggle.style.transform = '';
      }, 150);
      
      updateAudioState();
    });

    function playSound(sound) {
      if (audioEnabled && sound) {
        sound.currentTime = 0;
        sound.volume = 0.5;
        sound.play().catch(e => console.log('Sound error:', e));
      }
    }

    // === DONNÉES DU JEU ===
    const gameDataEl = document.getElementById('gameData');
    const gameState = {
      isAIMode: gameDataEl.dataset.aiMode === 'true',
      currentPlayer: Number(gameDataEl.dataset.currentPlayer),
      gameOver: gameDataEl.dataset.gameOver === 'true',
      winner: Number(gameDataEl.dataset.winner),
      soundToPlay: gameDataEl.dataset.soundToPlay || "",
      hasError: gameDataEl.dataset.error === '1'
    };

    const isAIMode = gameState.isAIMode;
    const currentPlayer = gameState.currentPlayer;
    const gameOver = gameState.gameOver;
    const winner = gameState.winner;
    const soundToPlay = gameState.soundToPlay;

    // === JOUER LES SONS DE FIN DE PARTIE ===
    window.addEventListener('load', () => {
      // Son de victoire/défaite
      if (soundToPlay === "win") {
        setTimeout(() => {
          if (winner === 1) {
            playSound(winSound);
          } else if (winner === 2 && !isAIMode) {
            playSound(winSound);
          } else if (winner === 2 && isAIMode) {
            playSound(loseSound);
          }
        }, 600);
      }
      
      // Son d'erreur
      if (gameState.hasError) {
        playSound(errorSound);
      }
    });

    // === GESTION DES FORMULAIRES ET IA ===
    const aiThinking = document.getElementById('aiThinking');
    const forms = document.querySelectorAll('.cell-form');
    
    // Vérifier si l'IA doit jouer (paramètre URL)
    const urlParams = new URLSearchParams(window.location.search);
    const aiShouldThink = urlParams.get('ai_thinking') === 'true';
    
    if (aiShouldThink && isAIMode && !gameOver) {
      // Afficher l'overlay "IA réfléchit"
      aiThinking.style.display = 'flex';
      
      // Désactiver tous les formulaires
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
      
      // Simuler le délai de réflexion de l'IA puis recharger
      setTimeout(() => {
        // Faire jouer l'IA côté serveur via fetch
        fetch('/ai-play', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          }
        }).then(() => {
          // Jouer le son de drop pour l'IA
          playSound(dropSound);
          
          // Petit délai pour entendre le son avant de recharger
          setTimeout(() => {
            window.location.href = '/game';
          }, 300);
        }).catch(err => {
          console.error('Erreur IA:', err);
          window.location.href = '/game';
        });
      }, 800);
    } else {
      // Masquer l'overlay si pas en mode IA thinking
      aiThinking.style.display = 'none';
    }
    
    // Gérer la soumission des formulaires
    forms.forEach(form => {
      form.addEventListener('submit', (e) => {
        // Jouer le son de drop
        playSound(dropSound);
        
        // Désactiver tous les formulaires pour éviter double-clic
        forms.forEach(f => f.style.pointerEvents = 'none');
      });
    });

    // Empêcher les interactions si c'est au tour de l'IA
    if (isAIMode && currentPlayer === 2 && !gameOver) {
      forms.forEach(form => {
        form.style.pointerEvents = 'none';
      });
    }
  </script>
</body>
</html>